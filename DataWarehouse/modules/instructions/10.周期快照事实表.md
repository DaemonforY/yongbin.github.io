前面章节对于事务事实表进行了详细的阐述，同时给出了淘宝交易事务事实表的设计过程，事务事实表可以很好的跟踪一个事件，并对其进行度量，以提供丰富的分析型能力。然而，当需要一些状态度量时，比如账户余额、买卖家星级、商品库存、卖家累积交易额等状态量，需要聚集与之相关的事务才能进行识别计算；或者聚集事务无法识别，比如温度等。对于这些状态度量，事务事实表是无效率的，而这些度量也是和度量事务本身一样是有用的，因此，维度建模理论给出了第二种常见的事实表——周期性快照事实表，或者简称为快照事实表。快照事实表在确定的间隔内对实体的度量进行抽样，这样可以很容易的研究实体的度量值，而不需要聚集长期的事务历史。接下来将以淘宝交易结束后的评价数据、卖家的累积支付金额、买卖家星级等事实表的设计来介绍快照事实表在阿里巴巴数据仓库中的设计与应用。

# 快照事实表特性

首先简要介绍下快照事实表的一些特性，快照事实表的设计有一些区别于事务事实表设计的性质。事务事实表的粒度能以多种方式表达，但快照事实表的粒度通常以维度形式声明。事务事实表是稀疏的，但快照事实表是稠密的。事务事实表中的事实是完全可加的，但快照模型将包含至少一个用来展示半可加性质的事实。

- 用快照采样状态

  快照事实表以预定的间隔采样状态度量。这种间隔，联合一个或多个维度，将被用来定义快照事实表的粒度，每行将包含记录所涉及状态的事实。

  这里以淘宝交易卖家自然年汇总事实表为例进行介绍，对于淘宝活动运营小二或者卖家自身经常都需要看一些交易状态数据，比如自然年至今或者历史至今的下单金额、支付金额、支付买家数、支付商品件数等等状态度量，于卖家而言，可能是每天早上都想看一下截至昨天的一个成交情况，于小二而言，可能频繁的活动周期就需要查看一次成交情况，这些状态度量可以每天通过事务事实表进行聚集，但随着时间跨度变大，聚集效率会越来越低，因此设计事实表快照进行状态的度量，这里用于采样的周期间隔就是每天，如图所示的快照事实表记录了每个卖家的下单和支付情况。

  ![fact_3_1-1](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/16896c53a4093c53c1b92cb1c85fbf73/fact_3_1-1.png)

  

- 快照粒度

  事务事实表的粒度可以通过业务过程中涉及到的细节程度来描述，但快照事实表的粒度通常总是被多维声明，可以简单理解为快照需要采样的周期以及什么将被采样。淘宝交易卖家事实表快照中，粒度可以理解为每天针对卖家的历史截至当日下单支付金额进行快照。

  当然快照周期并不一定都是按天来进行的。可以按照月或者季度来统计。比如淘宝交易有针对卖家加类目的每月汇总事实表，每月统计一次，同时维度也不仅一个，包含卖家和类目。

  

- 密度与稀疏性

  快照和事务事实表的一个关键区别也在于密度上。事务事实表是稀疏的，只有当天发生了相应的业务过程，事实表才会记录该业务过程的事实，如下单、支付等等；而快照是稠密的，无论当天是否有业务过程发生，都会记录一行，比如针对卖家的历史至今的下单和支付金额，无论当天卖家是否有下单支付事实，都会给该卖家记录一行。稠密性是快照事实表的重要特征，如果在每个快照周期内不记录行，比如和事务事实表一样，确定状态将变得非常困难。

  

- 半可加性

  快照事实表中收集到的状态度量都是半可加的。与事务事实表的可加事实不同，半可加事实不能根据时间维度获得有意义的汇总结果。比如对于淘宝交易事务事实表，可以对一段周期内的下单金额或者支付金额进行汇总，得到一段周期内的下单支付总额，但快照事实表在每个采样周期内是不能对状态度量进行汇总的，比如淘宝交易卖家快照事实表，无法对每天的历史至今的下单金额进行汇总，也没有汇总意义。虽然不能汇总，但可以计算一些平均值，比如计算每天的一个下单均值。

# 快照事实表实例

阿里巴巴数据仓库建模时，针对不同的业务场景，事务事实表无法满足所有需求，正如上一节介绍，在统计历史至今的卖家或者类目的下单金额和支付子订单数时，通过事务事实表聚集效率较低，而周期快照事实表则是可行的方案。接下来主要介绍阿里巴巴数据仓库几类周期快照事实表的设计过程。

通过前一节快照事实表的特性介绍，对于快照事实的设计步骤可以归纳为：

（1）确定快照事实的快照粒度；
（2）确定快照事实表采样的状态度量；

以下将依照这个步骤介绍几类常见的快照事实表。

- 单维度的每天快照事实表

  第一步：确定粒度。

  采样周期为每天，针对卖家、买家、商品、类目、地区等维度的快照事实表。如淘宝卖家历史至今汇总事实表、淘宝商品自然月至今汇总事实表等，不同的采样粒度确定了不同的快照事实表。

  第二步：确定状态度量。

  确定好粒度以后，就要针对这个粒度确定需要采样的状态度量。比如淘宝卖家历史至今汇总事实表，包含了历史截至当日的下单金额、历史截至当日的支付金额等等度量。淘宝卖家历史至今快照事实表，如图所示。

  ![fact_3_2-1](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/b1e98e30dd352b85524c518c76f3c548/fact_3_2-1.png)

  淘宝商品历史至今快照事实表，确定商品维度和商品状态度量，如图所示。

  ![fact_3_2-2](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/35a65338286900ca7df79f138e507da3/fact_3_2-2.png)

  

- 混合维度的每天快照事实表

  混合维度相对于单维度，只是在每天的采样周期上针对多个维度进行采样。比如淘宝交易买卖家截至当日快照事实表，采样周期依然是每天，维度是卖家加买家，反映的是不同买家对于不同卖家的下单支付金额。淘宝买卖家历史至今快照事实表，如图所示。

  ![fact_3_2-3](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/0301595f3ea3cd8b482ad26aedc125f7/fact_3_2-3.png)

  以上两类快照事实表都有一个特点——都可以从事务事实表进行汇总产出，这是周期快照事实表常见的一种产出模式，除此以外还有另外一种产出模式，即直接使用操作型系统的数据作为周期快照事实表的数据源进行加工，比如淘宝的卖家星级、卖家DSR事实表都是类似的，下面介绍这类事实表的设计过程。

  

- 淘宝卖家信用和DSR快照事实表

  在介绍这类事实表之前，首先介绍下淘宝卖家服务评价系统。在淘宝店铺交易成功以后会进行一次好中差评以及DSR评价（包括物流服务、描述相符和服务态度），淘宝卖家信用就是基于好中差评计算得出，DSR评分会累积计算一个综合分；天猫店铺交易完成以后仅有DSR评价，默认都是好评。卖家好中差评以及星级和卖家DSR评分如图所示。

  ![fact_3_2-4](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/7653740bc54c2b92e52467776d5ed249/fact_3_2-4.png)

  ![fact_3_2-5](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/88edaf3e47c6df23a2a734c023519a91/fact_3_2-5.png)

  其中淘宝卖家信用是通过好中差评的次数进行计算，具体为：好评加一分，中评零分，差评扣一分；然后累积最终的得分，得到卖家的信用，如图所示的卖家信用分是25318；DSR评分是通过分项的星级综合得到最终的评分，其中描述相符、服务态度和物流服务都是1到5星的打分方式，综合每一个星级的买家数得到最终的一个平均分，具体为：(1星*1星人数+2星*2星人数+3星*3星人数+4星*4星人数+5星*5星人数)/( 1星人数+2星人数+3星人数+4星人数+5星人数)。

  前面所述卖家信用分和DSR评分都是在操作型系统计算完成，阿里巴巴数据仓库关于淘宝卖家信用和DSR评分快照事实表是直接采用操作型系统数据进行设计加工，采样周期是每天，针对卖家维度的统计，状态度量就是卖家信用分和DSR评分。淘宝卖家信用分和DSR快照事实表，如图所示。

  ![fact_3_2-6](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/acd4f774f8eb66409e522dfb3d096d2c/fact_3_2-6.png)

- 全量事实表快照

  阿里巴巴数据仓库在设计快照事实表时，还有一类特殊的快照事实表，即全量型的事实表快照，这类事实表相对于前面所述的快照事实表特性有一些差异，但依然是周期快照事实表范畴，下面还是以淘宝好中差评价快照事实表阐述该类事实表的设计方法。

  第一步，确定粒度。淘宝好中差评是每天都在变化，下游统计分析也是每天进行的，因此确定采样周期是每天，这里的采样维度比较特殊，是针对评价本身，即每天按照评价进行采样，每一条好中差评价就是快照事实表的最细粒度。

  第二步，确定状态度量。对于好中差评价的度量更多关注的是评价本身，也即没有类似金额、商品数这样的度量，因此设计为无事实的事实表，更多是关注评价的状态。

  对于全量事实表快照，这里再增加一步，即冗余维度。如好中差评价快照事实表，冗余了子订单维度、商品维度、评论者维度、被评论者维度以及杂项维度，包括评论内容、是否匿名等信息。淘宝好中差评快照事实表，如图所示。

  ![fact_3_2-7](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/7897e74ef3c8ab75e5c5601ab4a248fd/fact_3_2-7.png)

# 10.3 快照事实表注意项

- 事务与快照成对设计

  数据仓库进行维度建模时，往往对于事务事实表和快照事实表都是成对的设计，进行互相补充，以满足更多的下游统计分析，特别在于，在事务事实表的基础上可以加工快照类事实表，如第二节所述的淘宝卖家历史至今的快照事实表，就是在事务事实表的基础上加工得到，既丰富了星型模型，又减轻了下游分析的成本。

  

- 附加事实

  快照事实表在确定状态度量时，一般都是保存采样周期结束时的状态的度量，但是往往也有分析需求需要关注前一个采样周期结束时的状态度量，而又不愿意多次使用快照事实表，因此一般在设计周期快照事实表时，会附加一些上一采样周期的状态度量。

  

- 周期到日期度量

  第二节介绍淘宝卖家历史至今快照事实表时，指定了统计周期是卖家历史至今的一些状态度量，比如历史截至当日的下单金额、成交金额等等，然后在实际应用中，也有需要关注自然年至今、季度至今、财年至今的一些状态度量，因此在周期快照事实表的度量确定时，也要考虑类似的度量值，以满足更多的统计分析需求。阿里巴巴数据仓库在设计周期快照事实表时，就针对多种周期到日期的度量设计了不同的快照事实表，比如淘宝卖家财年至今的下单金额、淘宝商品自然年至今的收藏次数等等。