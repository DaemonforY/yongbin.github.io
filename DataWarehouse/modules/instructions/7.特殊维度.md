本章主要介绍几种特殊的维度，递归层次维度及处理方法；行为维度的概念及几种常见的表现形式；多值维度和多值属性的概念及几种处理方式；杂项维度的概念等。



# 7.1 递归层次

  我们在第一章学习了维度的层次结构，即维度属性以层次方式或一对多方式相互关联；或者描述为不同的维度之间的主从关系。比如商品和类目的关系，商品和品牌的关系等。本节的递归层次指的是某维度的实例值的层次关系，比如淘宝类目体系，示例如下：

| 类目ID    | 类目名称      | 父类目ID | 是否叶子类目 |
| --------- | ------------- | -------- | ------------ |
| 50026579  | 圣诞服饰      | 50026576 | 是           |
| 50026576  | 节日\庆典用品 | 21       | 否           |
| 21        | 家居日用      | 0        | 否           |
| 121456022 | 台历          | 21       | 是           |

  维度的递归层次，按照层级是否固定分为均衡层次结构和非均衡层次结构。比如类目，有固定数量的级别，分别是叶子类目、五级类目、四级类目、三级类目、二级类目、一级类目；比如地区，分别是乡镇/街道、区县、城市、省份、国家。对于这种具有固定数量级别的递归层次，我们称为均衡层次结构。比如，公司之间的关系，每个公司可能存在一个母公司，但可能没有固定的一级、二级等的层级关系。对于这种数量级别不固定的递归层次，我们称为非均衡层次结构。

   淘宝交易事实表通过叶子类目和类目维表关联，假设统计类目ID为21的最近一天的GMV，如何进行统计。第一步，取父类目ID等于20的所有类目，称为子类目。第二步，对于每个子类目，如果为叶子类目，则终止；如果非叶子类目，则此类目ID作为父类目ID执行第一步，直到找到所有叶子类目，如圣诞服饰（50026579）、台历（121456022）等。将所有叶子类目和交易事实表关联进行统计汇总即可得到类目ID等于21的最近一天GMV，即家具日用类目的最近一天GMV。在物理实现时，可以使用递归SQL实现，如Oracle中connect by语法。

   通过数据探查得到ID等于21的类目属于一级类目（父类目ID等于0），统计其最近一天GMV的过程，称为上钻；在递归层次中进行上钻和下钻是很常见的。由于很多数据仓库系统和商业智能工具不支持递归SQL，且用户使用递归SQL的成本较高，所以在维度模型中，需要对此层次结构进行处理。

**层次结构扁平化**

  降低递归层次使用复杂度的最简单和有效的方法是层次结构的扁平化，通过建立维度的固定数量级别的属性来实现，可以在一定程度上解决上钻和下钻的问题。对于均衡层次结构，采用扁平化最为有效。

  对于淘宝商品类目，通过层次扁平化之后，类目维度表示如下，每个类目保存一条记录，并将其所属的各类目层级属性化。其中，对于高层级类目，由于其无低级类目，则低级类目置为空值。

![dim_4_1](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/93cdb8bef892bb43fdec385dd33ebd56/dim_4_1.png)

  具体数据存储示例如下，其中四级和五级类目省略：

| 类目ID    | 类目级别 | 是否叶子类目 | 一级类目 | 二级类目  | 三级类目 |
| --------- | -------- | ------------ | -------- | --------- | -------- |
| 21        | 1        | N            | 21       | ---       | ---      |
| 50026576  | 2        | N            | 21       | 50026576  | ---      |
| 50026579  | 3        | Y            | 21       | 50026576  | 50026579 |
| 121456022 | 2        | Y            | 21       | 121456022 | ---      |

  假设统计类目ID为21的最近一天的GMV，如何进行统计。将淘宝交易事实表通过叶子类目和类目维表的类目ID关联之后，限制一级类目ID等于21之后进行汇总统计，即可以得到类目ID等于21的最近一天的GMV，使用方便性大大提高。但存在如下三个方面的问题：

  （1）针对某类目上钻或下钻之前，必须知道其所属的类目层级，然后才能决定限制哪一级类目，如上述示例，限制一级类目ID等于21。

  （2）假设分三级类目统计最近一天交易GMV，由于某些叶子类目直接是一级类目或二级类目。比如类目ID等于121456022的类目，其是叶子类目。和交易事实表关联之后，由于其对应的三级类目为空，导致根据三级类目统计最近一天交易GMV时，类目ID等于121456022的交易无法被统计到。下游数据统计时，为了规避此问题，如此类目对应的三级类目为空，则取二级类目，如二级类目仍为空，则取一级类目。

  所以针对次问题，解决下游数据统计问题，类目层次扁平化的另一种方式是回填，将类目向下虚拟，具体数据示例如下，其中标红部分为回填内容。其中阿里巴巴中文站的类目体系使用此种方式。



| 类目ID    | 类目级别 | 是否叶子类目 | 一级类目 | 二级类目  | 三级类目  |
| --------- | -------- | ------------ | -------- | --------- | --------- |
| 21        | 1        | N            | 21       | 21        | 21        |
| 50026576  | 2        | N            | 21       | 50026576  | 50026576  |
| 50026579  | 3        | Y            | 21       | 50026576  | 50026579  |
| 121456022 | 2        | Y            | 21       | 121456022 | 121456022 |

  （3）第三个问题就是扁平化仅包含固定数量的级别，对于非平衡层次结构，可以通过预留级别的方式解决，但扩展性会较差。

**层次桥接表**

  针对层次结构扁平化存在的问题，可以采用桥接表的方式解决，不需要预先知道所属层级，也不需要回填，亦可解决非均衡层次的问题。与扁平化方法相比，该方法适合解决更宽泛的分析问题，灵活性更好；但复杂性高、使用成本高。

  仍然以类目为例，模型设计如下：

![dim_4_1-2](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/938ad1466123408533dc86ec812a32e3/dim_4_1-2.png)

  上一节提到的类目，使用树型结构表示如下：

![dim_4_1-3](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/7408c9d36f4ea8b2a5d7f91b60a911ab/dim_4_1-3.png)

  针对此类目树，类目桥接表的内如如下：

| 父类目ID  | 子类目ID  | 类目层级间隔 |
| --------- | --------- | ------------ |
| 21        | 21        | 0            |
| 21        | 50026576  | 1            |
| 21        | 121456022 | 1            |
| 21        | 50026579  | 2            |
| 50026576  | 50026576  | 0            |
| 50026576  | 50026579  | 1            |
| 121456022 | 121456022 | 0            |

  假设针对类目21进行下钻操作，步骤如下：限制类目表类目ID等于21，通过类目ID和类目桥接表的父类目ID关联，将两表建立连接；通过类目桥接表的子类目ID和交易事实表的类目ID关联，将此两表建立连接；即可针对订单事实进行下钻操作。涉及类目桥接表的数据见表格中父类目ID字段的黑色部分（21）。

  假设针对类目50026579进行上钻操作，步骤如下：限制类目表类目ID等于50026579，通过类目ID和类目桥接表的子类目ID关联，将两表建立连接；通过类目桥接表的父类目ID和交易事实表的类目ID关联，将此两表建立连接；即可针对订单事实进行上钻操作。涉及类目桥接表的数据见表格中子类目ID字段的黑色部分（50026579）。

  可以看到，层次桥接表解决了层次结构扁平化带来的一些问题；但由于其加工逻辑复杂、使用逻辑复杂，而且由于事实表和桥接表的多对多关系而带来了双重计算的隐患。实际应用中可以根据具体的业务需求来选择技术方案，如果在统计分析或报表中，一般都是按照固定级别进行，如按照一级类目统计GMV、按照省份统计GMV等，现在的扁平化设计完全可以满足需求，而不需要引入复杂的桥接表。很多时候，简单、直接的技术方案却是最好的解决方案。

# 7.2 行为维度

  在阿里巴巴的数据仓库中，存在很多如下的维表。比如卖家的主营类目、卖家主营品牌、用户常用地址等。其中卖家主营类目和主营品牌使用卖家的商品分布情况和卖家的交易分布情况，通过算法计算得到卖家的主营类目和主营品牌；其中卖家常用地址，使用最近一段时间内物流中卖家的发货地址和买家的收货地址进行统计得到。类似维度，都和事实相关，如交易、物流等，称之为行为维度，或事实衍生的维度。

  按照行为维度的加工方式，可以划分为以下几种：

  （1）另一个维度的过去行为，如买家最近一次访问淘宝的时间、买家最近一次发生淘宝交易的时间等；

  （2）快照事实行为维度，如买家年初截止当前的淘宝交易金额、买家信用分值、卖家信用分值等；

  （3）分组事实行为维度，将数值型事实转换为枚举值。如买家年初截止当前的淘宝交易金额按照金额划分的等级、买家信用分值按照分数划分得到买家信用等级等；

  （4）复杂逻辑事实行为维度，通过复杂算法加工或多个事实综合加工得到。如前面提到的卖家主营类目、如商品热度，根据访问、收藏、加入购物车、交易等情况综合计算得到。

  对于行为维度，有两种处理方式。一种是将其冗余至现有维度表中，如将卖家信用等级冗余至卖家维度表中。另外一种方式是加工单独的行为维度表，如卖家主营类目。具体采用哪种方式主要参考如下两个原则：

  第一，避免导致维度的过快增长。比如我们对商品表进行了极限存储，如果将商品热度加入现有商品维度表，可能会导致每日商品变更占比过高，而导致极限存储效果较差。

  第二，避免耦合度过高。比如卖家的主营类目，加工逻辑异常复杂，如果融合进现有的卖家维度表，过多业务耦合会导致卖家维度表刷新逻辑复杂、维护性差、产出延迟等。

# 7.3 多值维度

  对于多值维度，其中一种情况是，事实表的一条记录在某维度表中有多条记录对应。比如，对于淘宝交易订单，买家一次购买了多种商品，比如一件毛衣和两双袜子，称此次交易为父订单；对于每种商品的交易，称为子订单，对于此交易父订单，则有两个子订单与之对应。假设设计交易父订单事实表，则对于此事实表的每一条记录，在商品表中有一到多条记录与之对应。

  针对多值维度，常见的处理方式有三种，可以根据业务的表现形式和业务的统计分析需求进行选择。

  第一种处理方式是降低事实表的粒度。在淘宝交易中，前台业务和商业智能关注于交易子订单，所以在数据仓库模型设计中，将交易订单设计为子订单粒度，对于每个子订单，都只有一个商品相对应。对于其中的事实，则采用分摊到子订单的方式解决。但很多时候，事实表的粒度是不能降低的，多值维度的出现是无法避免的。

  第二种处理方式是多字段的方式。比如房地产销售中，每次合同签订可能存在多名买受人的情况，如夫妻合买等。对于合同签订事实表，每条记录可能对应多个买受人，而合同已经是此事实中的最细粒度，无法通过降低粒度的方式解决。由于合同签订的买受人一般不会太多，所以多字段的方式一般即可解决，考虑到扩展性，可以通过预留字段的方式解决，如超过三个买受方时，其余买受方填写至“其他买受方”字段。模型设计如下：

![dim_4_3-1](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/b2a224b084c87bef0bb5f3bf34c4ee28/dim_4_3-1.png)

  第三种处理方式是较为通用的桥接表方式。桥接表方式更加灵活、扩展性更好，但逻辑复杂、开发和维护成本较高，可能带来双重计算的风险，选择此方案需慎重。通过在事实表和维度表之间开发一张分组表，通过此分组表建立连接。模型设计如下，其中桥接表包含和事实表关联的分组KEY，以及作为买受方维表外键的买受方ID。如果事实表的一条记录对应两个买受方，则桥接表针对这两个买受方建立两条记录，分组KEY相同。

![dim_4_3-2](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/6acabdac83f4c59e17001404a2620b21/dim_4_3-2.png)

  假设根据买受方籍贯统计2015年的合同总金额，如果某合同有两个买受人，籍贯分别是浙江和山东，此合同金额将会分别统计至浙江和山东，造成双重计算。双重计算不一定是错误，对于某些业务需求确是合理的；但对某些业务需求，需要规避。

# 7.4 多值属性

  维度表中的某个属性字段同时有多个值，此种情况称为多值属性，也是多值维度的另一种表现形式。在阿里巴巴的数据仓库中，存在很多如下的维表。比如商品SKU维表、商品属性维表、商品标签维表等。每个商品均有一到多个SKU、一到多个属性和一到多个标签，所以商品和SKU、属性、标签都是多对多的关系。淘宝商品SKU和属性信息示例如下：

![dim_4_4-1](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/f8ff566ec9aaa78109f6c7756397669e/dim_4_4-1.png)

![dim_4_4-2](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/fc90d84a765954cd278a3521fe85ce0d/dim_4_4-2.png)

  对于多值属性，有三种常见的处理方式，和多值维度的第一种表现形式（上一节）相比既有相同点也有不同点，可以根据具体情况进行选择。

  第一种方式是保持维度主键不变，将多值属性放在维度的一个属性字段中。比如，对于商品属性（注：此属性是业务上含义，和维度建模中的维度属性含义不同），可以通过KV对的形式放在property字段中，数据示例如下：10281239:156426871; 137396765:29229; 137400766:3226633。此种处理方式扩展性好，但数据使用较为麻烦。

  第二种处理方式也是保持维度主键不变，但将多值属性放在维度的多个属性字段中。比如卖家的主营类目，由于卖家店铺中可能同时会销售男装、女装、内衣等，所以卖家的主营类目可能有多个，但业务需求只取根据算法计算得到的TOP3。针对此种情况，维度的多值属性字段具体值的数量固定，可以采用多个属性字段进行存储，方便数据的统计分析和报表展示。如果多值属性字段具体值的数量不固定，也可以采用预留字段的方式，但扩展性较差。卖家的主营类目维度设计如下：

![dim_4_4-3](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/192f9b9a78fbd7f2790191c0b8d5885e/dim_4_4-3.png)

  第三种处理方式是维度主键变化，一个维度值存放多条记录。比如商品SKU维表，对于每个商品，有多少SKU，即有多少记录，主键是商品的ID和SKU的ID。此种处理方式扩展性好，使用方便，但需要考虑数据的急剧膨胀。比如淘宝商品属性表采用了此种处理方式，数据记录达到几百亿的级别。

# 7.5 杂项维度

  在维度建模中，有一种维度叫Junk Dimension，中文一般翻译为“杂项维度”。杂项维度是由操作型系统中的指示符或者标志字段组合而成，一般不在一致性维度之列。比如淘宝交易订单的交易类型字段，包括话费充值、司法拍卖、航旅等等类型；支付状态、物流状态等，它们在源系统中直接保存在交易表中。

  一张事实表中可能会存在好几个类似的字段，如果作为事实存放在事实表中，会导致事实表占用空间过大；如果单独建立维度表，外键关联到事实表，会出现维度过多的情况；如果将这些字段删除，会有人不同意。

  这时，我们通常的解决方案就是建立杂项维度，将这些字段建立到一个维度表中，在事实表中只需保存一个外键。几个字段的不同取值组成一条记录，生成代理键，存入维度表，并将该代理键保存入相应的事实表字段。建议不要直接使用所有的组合生成完整的杂项维度表，在抽取时遇到新的组合时生成相应记录即可。杂项维度的ETL过程比一般的维度略为复杂。

  但在阿里巴巴实践中，杂项维度不仅包含上述所述的指示符、状态或分类等可枚举字段，还包括很多非可枚举字段，如交易留言、交易属性（若干KV对组成）、交易标签（二进制位表示）。针对这些字段，不可能生成所有的组合；同时，由于分布式计算系统中生成代理键的复杂度，一般在逻辑建模中，会使用实体的主键作为杂项维度的主键。只考虑杂项维度，忽略其他维度，如下所示：

![dim_4_5-1](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/13d8efd16358ebc79fd449539a10c345/dim_4_5-1.png)

  但子订单维度一般是逻辑模型，物理实现时不进行物理化，订单杂项维度和其它维度一起，会将维度属性退化至事实表，详情在事实表中描述。