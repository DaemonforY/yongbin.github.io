聚集是所有提高数据仓库性能的方法中，最有效的一种，可以使数据仓库的查询效率提高上百倍，甚至上千倍。

聚集和汇总不同，聚集必须提供与查询明细粒度数据一致的查询结果。

阿里巴巴结合具体的实践，提出公共汇总层的概念，将公共维度的汇总数据沉淀固话成公共汇总层表，极大提高了数据仓库的性能和易用性。



# 12.1 聚集的基本原则

- 一致性

  聚集表必须提供与查询明细粒度数据一致的查询结果。从设计的角度来看，确保一致性最简单的方法是确保聚集星型模式的维度和度量与原始模型中的维度和度量保持一致。

  

- 避免单一表设计

  不要在同一表中存储不同层次的聚集。如果这样做，将会导致双重计算或更糟糕的事情。聚集表中有些行存放按天汇总的交易额，有些行存放按月汇总的交易额，这将会让使用者产生误用导致重复计算。为了避免此类问题，通用的做法是需要在聚集时显示的加入数据层级列以示区别，但是这样会加大使用者的使用成本。但行之有效的另外一种方法是，把按天与按月汇总的交易额用两列存放，但是这样需要在列名上或者列注释上要能分辨出来。

  

- 聚集粒度可不同

  聚集并不需要保持与原始明细粒度数据一样的粒度，聚集只需关心所需要查询的维度。订单涉及的维度有商品、买家、卖家、地域，可以按照商品汇总一天商品的交易额，可以按照卖家汇总一天的营业额(交易额)，可以按照商品与地域汇总一月的交易额。

# 聚集的基本步骤

- 第一步：确定聚集维度。

  在原始明细模型中，会存在多个描述事实的维度，如日期、商品类别、卖家等，这时候需要确定根据什么维度聚集，如果只关心商品的交易额情况，那就可以只根据商品维度聚集数据。

  

- 第二步：确定一致性上钻。

  这个时候要关心是按月汇总还是按天汇总，你是按照商品汇总，还是按照类目汇总，如果按照类目汇总你也需要关心按照大类汇总，还是小类汇总。当然，要做的只是了解用户需要什么，按照他们想要的聚集。

  

- 第三步：确定聚集事实。

  原始明细模型中可能会有多个事实的度量，比如在交易中，有交易额，交易数量，这时候你要明确你是需要对交易额进行汇总，还是按照成交数量汇总。

# 12.3 阿里公共汇总层

## 基本原则

除了聚集的基本原则外，阿里建设公共汇总层还必须遵循以下原则：

**数据公用性**：汇总的聚集会有第三者使用吗？基于某个维度的聚集是不是经常用于数据分析中？如果是，那就有必要把明细数据经过汇总沉淀到聚集表中。

**不跨数据域**：数据域是在较高层次上对数据进行分类聚集的抽象。阿里以业务过程进行分类，如交易统一划到交易域下，商品的新增、修改放到商品域下。

**区分统计周期**：表命名上要能说明数据的统计周期，如_1d 表示最近1天，_td 截止到当天，_nd 表示最近N天。

## 交易汇总表设计

聚集是指针对原始明细粒度的数据进行汇总，假定已有的交易订单明细模型如下，可以看出事实和商品、卖家、买家等维度关联。

![fact_4_1-1](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/94b78409158e1c1c11d55bc0bc514c3c/fact_4_1-1.png)

潜在的聚集：



| 买家维度(2)     | 卖家维度(2)     | 商品维度(2)     | 店铺维度(2)     | 类目维度(3)              | 发货地区维度(5)            | ...  |
| --------------- | --------------- | --------------- | --------------- | ------------------------ | -------------------------- | ---- |
| 买家ID 买家性别 | 卖家ID 卖家性别 | 商品ID 商品类型 | 店铺ID 店铺类型 | 类目ID 一级类目 二级类目 | 地区ID 区县 城市 省份 国家 | ...  |


可以看出聚集的组合可能性为各个维度属性个数的乘积：2*2*2*2*3*5……..。

下面将按照聚集的基本步骤来介绍聚集表的设计流程。



### 按商品粒度汇总

**第一步**：确定聚集维度---商品。

**第二步**：确定一致性上钻---按商品(商品ID)按天汇总。

**第三步**：确定聚集事实---下单量，交易额

因此按商品聚集的星型模型如下：

![fact_5_3-1](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/d54d1c9db3e28293e1b3716bd2adf1ac/fact_5_3-1.png)

可以看出聚集的事实都是原始模型中的事实，聚集的维度也是原始模型维度中的商品维度，把其它不关心的维度去掉了。



### 按卖家粒度汇总

**第一步**：确定聚集维度---卖家。

**第二步**：确定一致性上钻---按卖家(卖家ID)按最近7天和最近30天汇总。

**第三步**：确定聚集事实---交易额

因此按卖家聚集的星型模型如下：

![fact_5_3-2](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/a4fb6b27b567133b2a4df95bea11eecb/fact_5_3-2.png)

我们在聚集的基本原则中说过，应该避免将不同层级的数据放在一起，为此我们选择用两列存放7天和30天的事实，但是需要在列名和字段注释上说明清楚。



### 按卖家、买家、商品粒度汇总

**第一步**：确定聚集维度---卖家、买家、商品。

**第二步**：确定一致性上钻---按卖家(卖家ID)、买家(买家ID)、商品(商品ID)最近1天汇总。

**第三步**：确定聚集事实---交易额

因此按卖家、买家、商品聚集的星型模型如下：

![fact_5_3-3](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/4d54f10266b1bedb3207fe5aa334364f/fact_5_3-3.png)

可以看出聚集的粒度越细，记录的条数也会越多，也会越接近原始明细模型的粒度。



### 按二级类目汇总

**第一步**：确定聚集维度---类目。

**第二步**：确定一致性上钻---按最近1天类目维度的二级维度属性汇总。

**第三步**：确定聚集事实---交易额

因此按二级类目聚集的星型模型如下：

![fact_5_3-4](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/78b7819e478ed4fad5402a64f5b234b8/fact_5_3-4.png)

与之前的3个聚集表不同的是，这个聚集模型不是根据维度主键属性进行的聚集，而是根据类目的层次维度属性进行的上钻聚集。

# 聚集补充说明

- 聚集是不跨越事实的

  聚集是针对原始星型模型进行的汇总，为了获取和查询原始模型一致的结果，聚集的维度和度量必须与原始模型保持一致，因此聚集是不跨事实的。横向钻取是针对多个事实基于一致性维度进行的分析，很多时候采用融合事实表，预先存放横向钻取的结果，从而提高查询性能。因此融合事实表是一种导出模式而不是聚集。

  

- 聚集带来的问题

  聚集会带来查询性能的提升，但聚集会增加ETL维护的难度。当子类目对应的一级类目发生变更时，那么先前存在的、已经被汇总到聚集表中的数据需要被重新调整。这一额外工作随着业务复杂性的加深，会导致多数ETL人员选择简单强力的方法，删除并重新建立聚集。