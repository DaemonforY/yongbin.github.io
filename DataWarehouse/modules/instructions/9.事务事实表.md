订单作为交易行为的核心载体，直观反映了交易的状况。订单的流转会产生很多的业务过程，而下单、支付和成功完结三个业务过程是整个订单的关键节点。获取这三个业务过程的笔数、金额以及转化率是日常数据统计分析的重点，事务事实表设计可以很好的满足这个需求。前面章节讨论了事实表的基础，您已经了解了事实表设计的原则和方法，本章将以此为基础介绍三种不同事务事实表的设计方式，以及淘宝交易订单中关于邮费和折扣在子订单的分摊算法。

# 事务事实表设计过程

事务，任何类型的事件都可以被理解为一种事务，比如交易过程中的创建订单、买家付款，物流过程中的揽货、发货、签收，退款中的申请退款、申请小二介入等等都可以理解为一种事务，事务事实表，即针对这些过程构建的一类事实表，用以跟踪定义业务过程的个体行为，提供丰富的分析型能力，作为数据仓库原子的明细数据。下面以淘宝交易事务事实表为例阐述事务事实表的一般设计过程。

第一步，选择业务过程。

上一章《事实表基础》给出了淘宝交易订单的流转过程，其中介绍了四个重要过程：创建订单、买家付款、卖家发货、买家确认收货，即下单、支付、发货和成功完结四个业务过程。这四个业务过程不仅是交易过程中的重要时间节点，同时也是下游统计分析的重点，因此淘宝交易事务事实表着重从这个四个业务过程进行展开。

Kimball维度建模理论认为，为了便于独立的分析研究，应该为每一个业务过程建立一个事实表，对于不同业务过程是否放到同一个事实表中，将在下一节详细介绍。

第二步，确定粒度。

业务过程选定以后，就要针对每个业务过程确定一个粒度，即确定事务事实表每一行所表达的细节层次，这里先介绍下淘宝订单过程。

淘宝出售商品主要分两类卖家，一类是个人性质的闲置卖家，主要出售闲置或者二手商品，另外一类是拥有店铺类的卖家，以出售新商品为主。接下来主要以店铺类的交易订单为主进行介绍。在淘宝下单交易时，有两种方式，一种是选定商品然后直接购买，这样会产生一条交易订单；另外一种是将多件商品加入到购物车，然后从购物车一起结算，此时对于每一件商品都会产生一个订单，同时对于同一个店铺会额外产生一个订单，即父订单，由于是同一个店铺购买，所以此时父订单会承载订单物流、店铺优惠等信息。而对于每一个商品产生的订单就称为子订单，子订单记录了父订单的订单号，并且有子订单标记。如果在同一个店铺只购买了一件商品则会将父子订单进行合并，只保留一条订单记录。如下所示，分别是父子订单合并一条和父子订单合并多条。



| 订单ID | 父订单ID | 创建时间            | 买家ID | 卖家ID | 商品ID | 金额  | 数量 | 是否子订单 | 是否父订单 |
| ------ | -------- | ------------------- | ------ | ------ | ------ | ----- | ---- | ---------- | ---------- |
| 1      | 1        | 2016-01-01 00:00:00 | 111    | 222    | 11111  | 100.0 | 1    | Y          | Y          |
| 9      | 9        | 2016-01-03 00:00:00 | 444    | 555    | 66666  | 500.0 | 2    | Y          | Y          |







| 订单ID | 父订单ID | 创建时间            | 买家ID | 卖家ID | 商品ID | 金额  | 数量 | 是否子订单 | 是否父订单 |
| ------ | -------- | ------------------- | ------ | ------ | ------ | ----- | ---- | ---------- | ---------- |
| 2      | 0        | 2016-01-01 00:00:00 | 111    | 222    | 0      | 0.0   | 3    | N          | Y          |
| 4      | 2        | 2016-01-01 00:00:00 | 111    | 222    | 11111  | 100.0 | 1    | Y          | N          |
| 5      | 2        | 2016-01-01 00:00:00 | 111    | 222    | 22222  | 50.0  | 2    | Y          | N          |
| 3      | 0        | 2016-01-02 00:00:00 | 333    | 777    | 0      | 0.0   | 6    | N          | Y          |
| 6      | 3        | 2016-01-02 00:00:00 | 333    | 777    | 33333  | 70.0  | 1    | Y          | N          |
| 7      | 3        | 2016-01-02 00:00:00 | 333    | 777    | 44444  | 80.0  | 2    | Y          | N          |
| 8      | 3        | 2016-01-02 00:00:00 | 333    | 777    | 55555  | 90.0  | 3    | Y          | N          |

了解了淘宝交易订单的产生过程后，接下来将为我们的淘宝交易事务事实表确定粒度。如第一步所述，淘宝交易过程中有四个重要业务过程，需要为每一个业务过程确定一个粒度。其中下单、支付和成功完结三个业务过程选择交易子订单粒度，即每一笔子订单为事务事实表的一行，每一笔子订单所表达的细节信息：交易时间、卖家、买家、商品，即选择图中订单ID为1、4、5、6、7、8的子订单作为事务事实表的每一行。卖家发货这个业务过程可以选择子订单粒度，即将每一笔子订单作为卖家发货事实表的一个细节，然而在实际操作中发现，卖家发货更多是物流单粒度而非子订单粒度，同一笔子订单可以拆开多笔物流进行发货，在事务事实表设计过程中，秉承确定粒度为最细粒度，因此对于卖家发货的粒度确定为物流单粒度，和其他三个业务过程不同，这样可以更好的给下游统计分析带来灵活性。

第三步，确定维度。

对于选定的业务过程并且确定粒度后，就可以确定维度信息。淘宝交易事务事实表在设计过程中，按照经常用于统计分析的场景，确定维度包含：买家维度、卖家维度、商品维度、商品类目维度、发货地区维度、收货地区维度、父订单维度以及杂项维度。由于订单的属性较多，比如订单的业务类型、是否无线交易、订单属性attributes等等，这些使用较多却又无法归属到上述买卖家或商品维度中则新建一个杂项维度进行存放。如图所示。

![fact_1_2-3](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/0fb912b87e28e79153186e28ecc30848/fact_1_2-3.png)

第四步，确定事实。

作为过程度量的核心，事实表应该包含与其描述过程有关的所有事实。以淘宝交易事务事实表为例，选定三个业务过程——下单、支付和成功完结，不同的业务过程拥有不同的事实。比如下单业务过程中，需要包含下单金额、下单数量、下单分摊金额，支付业务过程中，包含支付金额、分摊邮费、折扣金额、红包金额、积分金额，完结业务过程中包含确认收货金额等，由于粒度是子订单的，所以对于一些父订单上的金额需要平摊到子订单上，比如父订单邮费、父订单折扣等，具体分摊算法将在父子事实处理方式一节介绍。

根据Kimball维度建模理论，经过以上四步，淘宝交易事务事实表已初见成型，可以满足下游分析统计需要，然而阿里巴巴数据仓库在建模时，基于以上四个过程增加了一步——退化维度，这个过程在Kimball维度建模中也有所提及，但阿里数仓基于效率和资源考虑将常用维度全部退化到事实表中，使下游分析使用模型更加方便。

第五步，冗余维度。

第三步确定维度时，包含了买卖家维度、商品维度、类目维度、收发货维度等等，Kimball维度建模建议在事实表中只保存这些维度表的外键，而淘宝交易事务事实表在Kimball维度建模基础之上做了进一步的优化，将买卖家的星级、标签、店铺名称、商品类型、商品特征、商品属性、类目层级等等维度属性都冗余到事实表中，提高对事实表过滤查询、统计聚合的效率，如图所示。

![fact_1_2-4](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/8bf2fbe3756b2ef6839930cd6294815e/fact_1_2-4.png)





经过以上五个步骤，完成了淘宝交易事务事实表的设计。

但设计过程中遗留的一个问题，即单一事实表中是否包含多个业务过程，还没有给出定论，接下来将通过淘宝和1688交易过程中不同的设计方案来阐述两种设计方法。

# 单事务事实表

单事务事实表，顾名思义，即针对每一个业务过程设计一个事实表，这样设计的优点不言而喻，可以方便的对每一个业务过程进行独立的分析研究。1688交易流程则采用了这种模式构建了事务事实表。

1688交易和淘宝交易相似，主要流程也是下单、支付、发货和完结，而在这四个关键流程中1688交易选择下单和支付两个业务过程设计事务事实表，分别是1688交易订单创建事务事实表和1688交易订单支付事务事实表。

选定业务过程后，将对每一个业务过程确定粒度、维度和事实。对于1688交易订单创建事务事实表，确定子订单粒度，选择买家、卖家、商品、父订单、收货地区维度，事实包含下单分摊金额和折扣金额，如图所示 ；而对于1688交易订单支付事务事实表，粒度和维度和交易订单创建事务事实表相同，所表达的事实则不一样，包含支付金额、支付调整金额和支付优惠等，如图所示 。

![fact_1_2-5](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/455f93e0d4b2fe565fafe1d7d06ef84a/fact_1_2-5.png)   ![fact_1_2-6](http://aligitlab.oss-cn-hangzhou-zmf.aliyuncs.com/uploads/yongwei.wangyw/model/18edaada46b0be3ca8f278b3909fb5b6/fact_1_2-6.png)

1688交易针对下单和支付分别建立单事务事实表后，每天的下单记录则进入当天的下单事务事实表中，每天的支付记录进入当天的支付事务事实表中，由于事实表拥有稀疏性质，因此只有当天有数据才会进入当天的事实表中。下面以一条交易订单为例，展示单事务事实表的数据流转情况。order1在2016-01-01下单并且在当天完成支付；order2和order3在2016-01-01下单并且在2016-01-02完成支付。

表：交易订单详情实例

| 订单ID | 父订单ID | 下单时间            | 支付时间            | 完结时间            |
| ------ | -------- | ------------------- | ------------------- | ------------------- |
| order1 | mord1    | 2016-01-01 08:00:00 | 2016-01-01 10:00:00 | 2016-01-02 10:00:00 |
| order2 | mord2    | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | 2016-01-04 09:00:00 |
| order3 | mord2    | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | 2016-01-04 09:00:00 |
| order4 | mord2    | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | 2016-01-04 09:00:00 |

| 订单ID | 父订单ID | 买家ID | 卖家ID | 商品ID | 下单度量 | 支付度量 | 是否子订单 | 是否父订单 |
| ------ | -------- | ------ | ------ | ------ | -------- | -------- | ---------- | ---------- |
| order1 | mord1    | 111    | 222    | aa     | …        | …        | Y          | Y          |
| order2 | mord2    | 333    | 444    | 0      | …        | …        | N          | Y          |
| order3 | mord2    | 333    | 444    | bb     | …        | …        | Y          | N          |
| order4 | mord2    | 333    | 444    | cc     | …        | …        | Y          | N          |

表：1688交易订单创建事务事实表数据实例

| 业务日期 | 订单ID | 父订单ID | 下单时间            | 买家ID | 卖家ID | 商品ID | 下单度量 |
| -------- | ------ | -------- | ------------------- | ------ | ------ | ------ | -------- |
| 20160101 | order1 | mord1    | 2016-01-01 08:00:00 | 111    | 222    | aa     | …        |
| 20160101 | order3 | mord2    | 2016-01-01 09:00:00 | 333    | 444    | bb     | …        |
| 20160101 | order4 | mord2    | 2016-01-01 09:00:00 | 333    | 444    | cc     | …        |

表：1688交易订单支付事务事实表数据实例

| 业务日期 | 订单ID | 父订单ID | 支付时间            | 买家ID | 卖家ID | 商品ID | 支付度量 |
| -------- | ------ | -------- | ------------------- | ------ | ------ | ------ | -------- |
| 20160101 | order1 | mord1    | 2016-01-01 08:00:00 | 111    | 222    | aa     | …        |
| 20160102 | order3 | mord2    | 2016-01-02 09:00:00 | 333    | 444    | bb     | …        |
| 20160102 | order4 | mord2    | 2016-01-02 09:00:00 | 333    | 444    | cc     | …        |

# 多事务事实表

多事务事实表，将不同的事实放到同一个事实表中，即同一个事实表包含不同的业务过程。多事务事实表在设计时有两种方法进行事实的处理：1）不同业务过程的事实使用不同的事实字段进行存放；2）不同业务过程的事实使用同一个事实字段进行存放，但增加一个业务过程标签。接下来将分别通过淘宝交易事务事实表和淘宝收藏事务事实表分别阐述设计方法。

- 淘宝交易事务事实表

  淘宝交易事务事实表采取了将不同业务过程的事实使用不同事实字段进行存放的设计模式。淘宝交易事务事实表中同时包含了下单、支付和成功完结三个业务过程，这三个业务过程拥有相同的粒度，都是到子订单粒度，也比较适合放到同一个事实表中。选择业务过程时没有把发货也加到此事务事实表，原因如上一节确定粒度所述，由于发货的粒度比子订单更细，属于不同粒度上的业务过程，因此没有放到同一个事实表中。

  在确定好业务过程和粒度后，下一步就是确定维度和事实。对于不同的业务过程和粒度，一般而言，维度也不完全一致，但在设计淘宝交易事务事实表时，根据分析统计，常用维度比较一致，因此在维度层面可以保证这三个业务过程放到同一个事务事实表中，这里的维度也是交易过程中比较常见的，如前文所述包括买家、卖家、商品、类目、店铺、收发货地区等，无论在哪一个业务过程中，都需要按照这些维度进行统计分析。

  将多个业务过程放到同一个事实表中，将要面对的是如何处理多个事实。淘宝交易事务事实表包含下单、支付和成功完结三个业务过程，则需要包含下单的度量、支付的度量和成功完结时的度量信息，这里的解决方案是针对每一个度量都使用一个字段进行保存，即不同的事实使用不同的字段进行存放，如果不是当前业务过程的度量则采取零值处理。比如下单业务过程中，对于支付度量和成功完结度量全部置为0，其他业务过程类似处理。

  同一个事实表中包含了多个业务过程，在表中如何进行标记呢？淘宝交易事务事实表采取了这样的解决方案，即针对每一个业务过程打一个标签，标记当天是否是这个业务过程，比如针对下单，则打一个是否当天下单的标签，针对支付，打一个是否当天支付的标签，针对完结，打一个是否当天完结的标签，标签之间互不相干。淘宝交易事务事实表如图所示。

  表：交易订单详情实例

  | 订单ID | 父订单ID | 下单时间            | 支付时间            | 完结时间            |
  | ------ | -------- | ------------------- | ------------------- | ------------------- |
  | order1 | mord1    | 2016-01-01 08:00:00 | 2016-01-01 10:00:00 | 2016-01-02 10:00:00 |
  | order2 | mord2    | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | 2016-01-04 09:00:00 |
  | order3 | mord2    | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | 2016-01-04 09:00:00 |
  | order4 | mord2    | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | 2016-01-04 09:00:00 |

  | 订单ID | 父订单ID | 买家ID | 卖家ID | 商品ID | 下单度量 | 支付度量 | 是否子订单 | 是否父订单 |
  | ------ | -------- | ------ | ------ | ------ | -------- | -------- | ---------- | ---------- |
  | order1 | mord1    | 111    | 222    | aa     | …        | …        | Y          | Y          |
  | order2 | mord2    | 333    | 444    | 0      | …        | …        | N          | Y          |
  | order3 | mord2    | 333    | 444    | bb     | …        | …        | Y          | N          |
  | order4 | mord2    | 333    | 444    | cc     | …        | …        | Y          | N          |

  同样以一条交易订单为例，展示多事务事实表的数据流转情况。order1在2016-01-01下单并且在当天完成支付；order2和order3在2016-01-01下单并且在2016-01-02完成支付，在2016-01-04成功完结。如下面表格所示，同一个事实表中，包含有多个业务过程数据。

  | 业务日期 | 订单ID | 父订单ID | 是否当天下单 | 是否当天支付 | 是否当天完结 | 下单时间            | 支付时间            | 完结时间            |
  | -------- | ------ | -------- | ------------ | ------------ | ------------ | ------------------- | ------------------- | ------------------- |
  | 20160101 | order1 | mord1    | Y            | Y            | N            | 2016-01-01 08:00:00 | 2016-01-01 10:00:00 | NULL                |
  | 20160101 | order3 | mord2    | Y            | N            | N            | 2016-01-01 09:00:00 | NULL                | NULL                |
  | 20160101 | order4 | mord2    | Y            | N            | N            | 2016-01-01 09:00:00 | NULL                | NULL                |
  | 20160102 | order1 | mord1    | N            | N            | Y            | 2016-01-01 08:00:00 | 2016-01-01 10:00:00 | 2016-01-02 10:00:00 |
  | 20160102 | order3 | mord2    | N            | Y            | N            | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | NULL                |
  | 20160102 | order4 | mord2    | N            | Y            | N            | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | NULL                |
  | 20160104 | order3 | mord2    | N            | N            | Y            | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | 2016-01-04 09:00:00 |
  | 20160104 | order4 | mord2    | N            | N            | Y            | 2016-01-01 09:00:00 | 2016-01-02 09:00:00 | 2016-01-04 09:00:00 |

  | 业务日期 | 订单ID | 父订单ID | 买家ID | 卖家ID | 商品ID | 下单度量 | 支付度量 | 完结度量 |
  | -------- | ------ | -------- | ------ | ------ | ------ | -------- | -------- | -------- |
  | 20160101 | order1 | mord1    | 111    | 222    | aa     | …        | …        | 0.0      |
  | 20160101 | order3 | mord2    | 333    | 444    | bb     | …        | 0.0      | 0.0      |
  | 20160101 | order4 | mord2    | 333    | 444    | cc     | …        | 0.0      | 0.0      |
  | 20160102 | order1 | mord1    | 111    | 222    | aa     | …        | …        | …        |
  | 20160102 | order3 | mord2    | 333    | 444    | bb     | …        | …        | 0.0      |
  | 20160102 | order4 | mord2    | 333    | 444    | cc     | …        | …        | 0.0      |
  | 20160104 | order3 | mord2    | 333    | 444    | bb     | …        | …        | …        |
  | 20160104 | order4 | mord2    | 333    | 444    | cc     | …        | …        | …        |

- 淘宝收藏商品事务事实表

  收藏和加购物车是淘宝购物过程中比较常见的两个行为，当用户遇到喜欢的商品或者店铺时可以选择收藏然后下次继续浏览购买。这里以收藏事务事实表阐述多事务事实表在处理不同业务过程使用同一个字段保存事实的设计方式。

  收藏业务较为简单，商品和店铺的收藏业务相似，这里仅以收藏商品为例进行阐述。用户可以直接收藏一个商品，收藏后可以删除收藏的这个商品，所以在这个过程中包含了两个业务过程：收藏商品和删除商品。因此收藏商品事务事实表的第一步选择业务过程，就选定收藏商品和删除商品两个业务过程。业务过程确定后，就是确定粒度。无论是收藏商品还是删除收藏的商品，都是用户对商品的一个操作，因此这里确定用户加上商品的粒度。

  业务过程和粒度确定好后，接下来是确定维度和事实。由于粒度是用户加上商品，所以维度主要是用户维度和商品维度，为了使事实表信息更丰富，冗余了商品类目维度和商品所属卖家维度，收藏商品和删除商品业务过程所属维度都是一致的。

  收藏和删除两个不同的业务过程，但是确定了相同的粒度和维度，所以考虑设计多事务事实表，将这两个业务过程放到同一个事实表中，只是在不同业务过程的事实上进行区分，前一节是通过不同字段存放不同业务过程的事实，这里的解决方案是通过同一个字段存放不同业务过程的事实，使用标签字段区分不同业务过程，比如收藏事务事实表使用一个“收藏事件类型”字段来区分是收藏商品还是删除商品。收藏商品和删除商品的事实主要是商品价格，不过收藏事务事实表更多是无事实的事实表，一般用于统计收藏或者删除的次数。

  下面通过一组实例来说明收藏事务事实表的设计过程。

  表：收藏商品明细

  | 收藏时间            | 删除时间            | 商品ID | 会员ID | 商品度量 |
  | ------------------- | ------------------- | ------ | ------ | -------- |
  | 2016-01-01 08:00:00 | null                | aa     | 111    | …        |
  | 2016-01-01 12:00:00 | 2016-01-01 18:00:00 | aa     | 222    | …        |
  | 2016-01-01 08:00:00 | 2016-01-01 08:00:00 | bb     | 333    | …        |

  表：收藏商品事务事实表

  | 业务日期 | 收藏时间            | 删除时间            | 商品ID | 会员ID | 商品度量 | 收藏删除类型 |
  | -------- | ------------------- | ------------------- | ------ | ------ | -------- | ------------ |
  | 20160101 | 2016-01-01 08:00:00 | null                | aa     | 111    | …        | collect      |
  | 20160101 | 2016-01-01 12:00:00 | 2016-01-01 18:00:00 | aa     | 222    | …        | delete       |
  | 20160101 | 2016-01-01 08:00:00 | null                | bb     | 333    | …        | collect      |
  | 20160102 | 2016-01-01 08:00:00 | 2016-01-02 08:00:00 | bb     | 333    | …        | delete       |

- 多事务事实表的选择

  上面介绍了两种多事务事实表的设计方式，在实际应用中选择哪一类需要因业务过程不同而不同。由于是多事务事实表，因此在事实表中包含多个业务过程：

  当不同业务过程的度量比较相似、差异不大时则采用第二种多事务事实表的设计方式，使用同一个字段来表示度量数据，但这种方式面对一个问题——同一个周期内会存在多条记录；

  当不同业务过程的度量差异较大时，可以选择第一种多事务事实表的设计方式，将不同业务过程的度量使用不同字段冗余到表中，非当前业务过程则置零表示，问题是度量字段零值较多。

# 9.4 两类事实表对比

前面介绍了单事务事实表和多事务事实表的设计过程，同时给出了1688和淘宝关于不同事务事实表的实例。目前两类事实表都有实际的应用，但具体哪一种设计方式更优，我们接下来做一个分析。

- 业务过程

  单事务事实表对一个业务过程建立一张事实表，只反映一个业务过程的事实；多事务事实表在同一张事实表中反映多个业务过程。多个业务过程是否放到同一个事实表中，首先需要分析不同业务过程之间的相似性和业务源系统，比如淘宝交易的下单、支付和成功完结这三个业务过程是存在相似性的，都是属于订单处理中的一环，并且都是来自于交易系统，因此适合放到同一个事务事实表中。

  

- 粒度和维度

  在考虑单事务事实表还是多事务事实表，另一个关键点就是粒度和维度，在确定好几个业务过程后，需要基于不同业务过程确定粒度和维度，当不同业务过程的粒度相同，同时拥有相似的维度，此时就可以考虑多事务事实表方式。如果粒度不同，则必定是不同的事实表，比如交易中支付和发货则不属于同一粒度，无法将发货业务过程放到淘宝交易事务事实表中。

  

- 事实

  对于不同的业务过程，事实往往是不同的，单事务事实表在处理事实上比较方便和灵活，仅仅体现同一个业务过程的事实即可。而多事务事实表由于有多个业务过程，所以有更多的事实需要处理，如果单一业务过程的事实较多，同时不同业务过程的事实又不相同，则可以考虑使用单事务事实表，处理更加清晰，若使用多事务事实表则会导致事实表零值或空值字段较多。

  

- 下游业务使用

  单事务事实表于下游用户而言更容易理解，关注哪个业务过程则使用相应的事务事实表；而多事务事实表包含多个业务过程，用户使用时往往较为困惑。1688和淘宝交易分别采用了这两种方式，从日常使用来看，淘宝交易事务事实表下游确实有一定的学习成本。

  

- 计算存储成本

  针对多个业务过程设计事务事实表，采用单事务还是多事务，对于数据仓库的计算存储成本也是参考点之一，当业务过程数据来源于同一个业务系统，具有相同的粒度和维度，另外维度较多而事实相对不多，此时可以考虑使用多事务事实表，不仅加工计算成本较低，同时存储上也相对节省，此时多事务事实表是一个较优的处理方式。

  通过一个表格描述下两类事务事实表的比较，如下所示。

|              | 单事务事实表                         | 多事务事实表                                                 |
| ------------ | ------------------------------------ | ------------------------------------------------------------ |
| 业务过程     | 1个                                  | 多个                                                         |
| 粒度         | 相互间不相关                         | 相同粒度                                                     |
| 维度         | 相互间不相关                         | 一致                                                         |
| 事实         | 只取当前业务过程中的事实             | 保留多个业务过程中的事实，非当前业务过程的事实需要置零处理   |
| 冗余维度     | 多个业务过程，则需要冗余多次         | 不同的业务过程只需要冗余一次                                 |
| 理解程度     | 易于理解，不会混淆                   | 难以理解，需要通过标签来限定                                 |
| 计算存储成本 | 较多，每一个业务过程需要计算存储一次 | 较少，不同业务过程融合到一起，降低存储计算量， 但是非当前业务过程的度量存在大量零值 |

# 父子事实的处理方式

淘宝交易父子订单的含义在前文确定粒度时有所说明，同一家店铺同时下单的多件商品，不仅每件商品有一个子订单，这几个子订单会再单独产生一个父订单。下单和支付都是在父订单粒度上完成的，比如拍下时的订单总额、支付的总额、支付的邮费，淘宝交易事务事实表在粒度选取上，按照粒度最细原则，确定为子订单，因此需要将下单总额或者支付总额分摊到每个子订单上，当然只有一个子订单时是不需要进行分摊的。这里以子订单分摊的有效下单金额和子订单分摊的支付金额加以说明。

子订单下单金额=下单商品数量*商品价格

子订单分摊有效下单金额=下单商品数量*商品价格+父订单邮费*下单分摊比例-子订单折扣-父订单折扣*下单分摊比例

下单分摊比例=(下单商品数量*原价-子订单折扣)/sum(下单商品数量*原价-子订单折扣)

子订单分摊的支付金额=父订单支付金额*支付分摊比例

支付分摊比例=(下单商品数量*原价-子订单折扣+调价)/sum(下单商品数量*原价-子订单折扣+调价)

通过分摊父订单的金额将所有业务过程的度量全部带进淘宝交易事务事实表中，包括了下单数量、商品价格、子订单折扣、下单分摊比例、父订单支付金额、父订单支付邮费、父订单折扣、子订单下单金额、子订单下单有效金额、支付分摊比例、子订单支付金额等等，将父子事实同时冗余到事务表中。

# 事实的设计准则

- 事实完整性

  事实表包含与其描述的过程有关的所有事实，即尽可能多的获取所有的度量。在淘宝交易事务事实表中，比如支付业务过程，子订单粒度上的支付金额、支付邮费、支付红包、支付积分、支付折扣，都有所包含，覆盖全面。

  

- 事实一致性

  在确定事务事实表的事实时，明确的存储每一个事实以确保度量的一致性。以淘宝交易事务事实表为例，下单业务过程中，有下单商品数量和商品价格两个事实，但在事实表中计算了下单金额和下单有效金额，这些可以通过商品数量乘以商品价格进行计算，虽然下游在取数时也可以通过这种方式完成计算，但是在事实表中统一计算可以保证这个度量的一致性，其他如支付过程中的分摊金额等也是类似的。

  

- 事实可加性

  事实表确定事实时，往往会遇到非可加性的度量，比如分摊比例、利润率等，这些虽然也是下游分析的关键点，但往往在事务事实表中更多是关注可加性的事实，下游用户在聚合统计时更加方便。在淘宝交易事务事实表中，存储了分摊比例这样的度量，但更多的是存储各类金额的度量。