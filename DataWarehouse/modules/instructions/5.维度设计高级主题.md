集成是数据仓库的四个特性中最重要的一点，维度设计中需要考虑如何集成来自应用的大量分散的操作型环境的数据。

维度有两种拆分方式，水平拆分和垂直拆分。水平拆分通常基于维度类别或类型进行细分。

垂直拆分通常基于扩展性、产出时间、易用性等方面的进行考虑。主维度表存放稳定、产出时间早、热度高的属性；从维度表存放变化较快、产出时间晚、热度低的属性。

阿里巴巴历史截止当前的淘系商品约有几百亿的记录，在数据仓库占用约18T的存储。面对如此庞大的数据量，如何设计模型、如何降低存储、如何让下游方便获取数据，成为必须要解决的问题。数据归档是解决此问题的有效方法之一。



# 维度整合

  我们先来看下数据仓库的定义：数据仓库是一个面向主题的、集成的、非易失的且随时间变化的数据集合，用来支持管理人员的决策。其中集成是数据仓库的四个特性中最重要的一点。

  数据仓库的重要数据来源是大量的、分散的面向应用的操作型环境。不同的应用在设计过程中，可以自由决策，主要满足本应用的需求，很少会考虑和其它系统进行数据集成。应用的差异具体表现在如下几个方面：

  （1）应用在编码、命名习惯、度量单位等方面会存在很大差异。比如不同应用对于用户的性别编码不同：有0和1，有F和M等；不同应用用户ID含义相同但字段名称不同：有user，有user_id等；不同应用对于金额的度量单位不同：有元，有分等等。

  （2）应用基于性能和扩展性的考虑，或者随技术架构的演变，或者随业务的发展，采用不同的物理实现。拆分至不同类型数据库，部分数据采用关系型数据库存储（如Oracle、Mysql等），部分数据采用NoSQL数据库存储（如Hbase、Tair等）。拆分成同一类型数据库中多张的物理表，比如淘宝商品，有商品主表和商品扩展表，商品主表存商品基本信息；商品扩展表存储商品特殊信息，如不同产品线定制化的信息等；比如淘宝会员，有会员主表和会员扩展表，会员主表存用户基本信息；会员扩展表存储用户扩展信息，如用户的各种标签信息等。

  所以数据由面向应用的操作型环境进入数据仓库后，需要进行数据集成。将面向应用的数据转换为面向主题数据仓库数据，本身就是一种集成。具体体现在如下几个方面：

  （1）命名规范的统一。表名、字段名等统一；

  （2）字段类型的统一。相同和相似字段的字段类型的统一；

  （3）公共代码及代码值的统一。公共代码及标志性字段的数据类型、命名方式等的统一；

  （4）业务含义相同的表的统一。主要依据高内聚、低耦合的理念，在物理实现中，将业务关系大、源系统影响差异小的进行整合；业务关系小、源系统影响差异大的进行分而置之。通常有如下集成方式：

  a、采用主从表的设计方式，两表或多表都有的字段放在主表中（主要基本信息），从属信息分别放在各自的从表中。对于主表中的主键，要么采用复合主键，源主键和系统或表区别标志；要么采用唯一主键，“源主键||系统或表区别标志”生成新的主键。通常建议采用复合主键的方式。

  b、直接合并，共有信息和个性信息都放在同一个表中。如果表字段的重合度较低，会出现大量空值，对于存储和易用性会有影响，需谨慎选择。

  c、不合并，源表的表结构及主键等差异很大，无法合并，使用数据仓库里的多个表存放各自数据。

  维度表的整合涉及的内容和上面介绍的几个方面相同，下面重点看一下表级别的整合，有两种表现形式。

  第一种是垂直整合，即不同的来源表包含同一数据集，只是存储的信息不同。比如淘宝会员在源系统有多张表，会员基础信息表、会员扩展信息表、淘宝会员等级信息表、天猫会员等级信息表。这些表都属于会员相关信息表，依据维度设计方法，尽量整合至会员维度模型中，丰富其维度属性。

  第二种是水平整合，即不同的来源表包含不同的数据集，不同子集之间无交叉，亦可以存在部分交叉，比如针对蚂蚁金服数据仓库，其采集的会员数据有淘宝会员、1688会员、国际站会员、支付宝会员等，是否需要将所有的会员整合成一张会员表？如果进行整合，首先需要考虑各个会员体系是否有交叉，如果存在交叉，则需要去重；如果不存在交叉，不同子集的自然键是否存在冲突，如果不冲突，可以考虑将各子集的自然键作为整合后的表的自然键；另外一种方式是设置超自然键，来源+各子集的自然键加工成一个字段作为超自然键。在阿里巴巴，常用的方式是将来源各子集的自然键作为联合主键的方式，并且在物理实现时，将来源字段作为分区字段。

  有整合就有拆分，到底是做整合还是拆分，都有哪些因素决定。我们在下面两节讨论维度的水平拆分和垂直拆分。

# 水平拆分

  维度通常可以按照类别或类型细分。比如淘系商品表，根据业务线或行业等可以对商品进行细分，比如淘宝的商品、天猫的商品、1688的商品、阿里去啊的商品、淘宝海外的商品、天猫国际的商品等。不同分类的商品，其维度属性可能相同，也可能不同。比如阿里去啊的商品和普通的淘系商品，都属于商品，都有商品价格、标题、类型、上架时间、类目等维度属性，但是阿里去啊商品除了有这些公共属性，还有酒店、景点、门票、旅行等自己独特的维度属性。

  如何设计维度？针对此问题，主要解决方案有两种，方案1是将维度的不同分类实例化为不同的维度，同时在主维度中保存公共属性；方案2是维护单一维度，包含所有可能的属性。

  选择哪种方案？数据模型设计过程中需要考虑的因素很多，基本不可能满足各个特性指标的最优化。在设计过程中需要重点考虑以下三点原则：

  （1）扩展性：指在源系统、业务逻辑变化的时候，能通过少的成本快速扩展模型，保持核心模型的相对稳定性。软件工程中高内聚、低耦合的思想是重要的指导方针之一。

  （2）效能：性能和成本方面的平衡。通过牺牲一定的存储成本，达到性能和逻辑上的优化。

  （3）易用性：模型可理解性高、访问复杂度低。用户能够方便的从模型中找到对应的数据表，并能够方便查询和分析。

  根据数据模型设计思想，在做维度的水平拆分时，主要考虑如下两个依据：

  第一个依据是，维度的不同分类的属性差异情况。当维度属性随类型变化较大时，将所有可能的属性建立在一张表中是不切合实际和没有必要的，此时建议采用方案1。定义一个主维度存放公共属性；同时定义多个子维度，除包含公共属性外，还包含各自子维度的特殊属性。比如在阿里巴巴数据仓库维度体系中，依据此方法，构建了商品维度、阿里去啊商品维度等。公共属性一般比较稳定，通过核心的商品维度，保证了核心维度的稳定性；通过扩展子维度的方式，保证了模型的扩展性。

  另外一个重要依据是，业务的关联程度。两个相关性较低的业务，耦合在一起弊大于利，对于模型的稳定性和易用性影响较大。比如阿里巴巴数据仓库维度体系中，我们将淘系商品和1688商品构建两个维度。虽然淘系和1688商品底层技术实现上是统一的，但属于不同的业务BU，业务各自发展；在数据仓库层面，淘系和1688属于不同的数据集市，一般不会相互调用，业务分析人员一般只针对本数据集市进行统计分析。如果设计成一个维度，由于不同BU业务各自发展，1688业务变更，此维度需要变更，淘宝业务变更亦然，稳定性很差；易用性方面，会给数据使用方造成困扰。

# 5.3 垂直拆分

  在第一章维度设计中，我们提到维度是维度建模的基础和灵魂，维度属性的丰富程度直接决定了数据仓库的能力。在做维度设计时，依据维度设计的原则，尽可能丰富了维度属性，同时进行了反规范化处理。对于具体实现时可能存在问题，一方面是水平拆分中提到的，维度属性由于维度分类的不同而存在特殊属性，通过水平拆分的方式解决此问题。

  另一方面的问题是某些维度属性的来源表产出时间较早，而某些属性的来源表产出时间较晚；或者某些维度属性的热度高、使用频繁，而某些维度属性热度低、较少使用；或者某些维度属性经常变化，而某些属性比较稳定。水平拆分中提到的模型设计的三个原则同样适用于解决此问题。

  基于扩展性、产出时间、易用性等方面的考虑，设计主从维度。主维度表存放稳定、产出时间早、热度高的属性；从维度表存放变化较快、产出时间晚、热度低的属性。比如在阿里巴巴数据仓库中，我们设计了商品主维度和商品扩展维度。其中商品主维度在每日的01:30左右产出，而商品扩展维度由于冗余了产出时间较晚的商品品牌和标签信息，在每日的03:00左右产出；另外，商品扩展维度冗余了库存等变化较快的数据，对于主维度进行缓慢变化的处理较为重要。通过存储的冗余和计算成本的增加，实现了商品主模型的稳定和产出时间提前，对于整个数据仓库的稳定和下游应用的产出都有较大意义。

# 历史归档

  阿里巴巴历史截止当前的淘系商品约有几百亿的记录，在数据仓库占用约18T的存储。面对如此庞大的数据量，如何设计模型、如何降低存储、如何让下游方便获取数据，成为必须要解决的问题。是否存在历史数据，前台已经不再使用。答案是肯定的，如此庞大的数据，现有的技术架构也很难处理。前台有一套数据归档的策略，比如将商品状态为下架或删除的且最近31天未更新的商品归档至历史库；具体逻辑根据不同业务BU有不同的算法，且有特殊的规则。

  数据仓库中，理所当然可以借用前台数据库的归档策略，定期将历史数据归档至历史维表。在实践中，阿里巴巴数据仓库设计商品维度表和历史商品维度表，每天将历史数据归档至历史商品维度表。关于归档策略的选择，可以有以下几种方式：

  （1）同前台归档策略，将前台归档算法在数据仓库中实现，定期将历史数据进行归档。但存在一些问题，一方面是前台归档策略复杂，实现成本较高；另外一方面，前台归档策略可能会经常变化，会导致数据仓库归档算法也要随之变化，维护和沟通成本较高。此方法适用于同前台归档策略逻辑较为简单，且变更不频繁的情况。

  （2）同前台归档策略，但采用数据库变更日志的方式。对于如此庞大的数据，阿里巴巴采用的数据抽取策略一般是通过数据库binlog解析获取每日增量，通过增量merge全量的方式获取最新全量数据。可以使用增量日志的删除标记，作为前台数据归档的标记。通过此标记对数据仓库的数据进行归档。此方法不需要关注前台归档策略，简单易行。但对前台应用的要求是数据库的物理删除只有在归档时才执行，应用中的删除只是逻辑删除。

  （3）数据仓库自定义归档策略。可以将归档算法用简单直接的方式实现，但此方法的原则是尽量比前台应用晚归档、比前台应用少归档。避免数据仓库中已经归档的数据再次更新的情况出现。

  如果技术条件允许，能够解析数据库binlog日志，建议使用归档策略2，规避前台算法。具体可以根据自身数据仓库的实际情况进行选择。